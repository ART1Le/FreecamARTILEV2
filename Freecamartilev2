--[[ 
    CINEMATIC FREECAM PRO - PREMIUM UI EDITION
    Status: Fully Functional (No Logic Removed)
    UI Style: Modern Dark/Cyber (Glassmorphism)
]]

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- MODULE KONTROL
local PlayerModule = require(localPlayer:WaitForChild("PlayerScripts"):WaitForChild("PlayerModule"))
local Controls = PlayerModule:GetControls()

-- === [1. THEME SETTINGS (REMASTERED)] ===
local Theme = {
    Colors = {
        Background = Color3.fromRGB(12, 12, 18),   -- Sangat gelap (Deep Space)
        Surface    = Color3.fromRGB(22, 24, 32),   -- Panel input
        Border     = Color3.fromRGB(45, 50, 70),   -- Border halus
        Text       = Color3.fromRGB(240, 240, 240),-- Putih terang
        SubText    = Color3.fromRGB(150, 160, 180),-- Abu-abu
        
        Accent     = Color3.fromRGB(0, 160, 255),  -- Biru Neon
        ToggleOn   = Color3.fromRGB(0, 180, 255),  -- Biru Aktif
        Button     = Color3.fromRGB(30, 34, 45),   -- Tombol Mati
        Hover      = Color3.fromRGB(40, 45, 60),   -- Efek Hover
        Input      = Color3.fromRGB(15, 16, 22)    -- Input Box
    },
    Fonts = {
        Title = Enum.Font.GothamBold,
        Body  = Enum.Font.GothamSemibold,
        Small = Enum.Font.Gotham,
    },
    Radius = 10, -- Sudut lebih membulat
}

-- === [2. STATE VARIABLES (ORIGINAL)] ===
local freecamEnabled = false
local followEnabled = false
local symLockEnabled = false
local followMode = "OFF"

local targetPlayer1 = nil
local targetPlayer2 = nil

local cameraSpeed = 1.0
local sensitivity = 1.5
local normalSmooth = 0.15
local shiftSmooth = 0.07

local pan = Vector2.new(0, 0)
local targetCFrame = camera.CFrame
local defaultFOV = 70
local targetFOV = defaultFOV 
local hiddenGuis = {}

-- === [3. UI HELPERS (ENHANCED)] ===
local function createRound(parent, radius) 
    local c = Instance.new("UICorner") 
    c.CornerRadius = UDim.new(0, radius or Theme.Radius) 
    c.Parent = parent 
    return c
end

local function createStroke(parent, color, thickness, transparency) 
    local s = Instance.new("UIStroke") 
    s.Thickness = thickness or 1.2
    s.Color = color or Theme.Colors.Border 
    s.Transparency = transparency or 0.5
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border 
    s.Parent = parent 
    return s
end

-- Efek animasi saat kursor masuk/keluar tombol
local function applyHoverEffect(guiObject)
    local originalColor = guiObject.BackgroundColor3
    
    guiObject.MouseEnter:Connect(function()
        TweenService:Create(guiObject, TweenInfo.new(0.2), {
            BackgroundColor3 = Theme.Colors.Hover
        }):Play()
    end)

    guiObject.MouseLeave:Connect(function()
        -- Cek apakah tombol sedang dalam mode "ON" (kita pakai Attribute untuk tracking)
        local isActive = guiObject:GetAttribute("IsActive")
        local targetColor = isActive and Theme.Colors.ToggleOn or Theme.Colors.Button
        
        TweenService:Create(guiObject, TweenInfo.new(0.2), {
            BackgroundColor3 = targetColor
        }):Play()
    end)
end

local function makeDraggable(frame)
    local dragging, dragInput, dragStart, startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        -- Gunakan Tween agar gerakan drag terasa smooth sedikit
        TweenService:Create(frame, TweenInfo.new(0.05), {
            Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        }):Play()
    end
    
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then update(input) end
    end)
end

-- === [4. GUI SETUP (NEW DESIGN)] ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CinematicFreecam_Pro_V2"
ScreenGui.Parent = localPlayer:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true 

-- MAIN CONTAINER
local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 280, 0, 480) -- Lebih tinggi sedikit untuk estetika
MainFrame.Position = UDim2.new(0.5, -140, 0.5, -240)
MainFrame.BackgroundColor3 = Theme.Colors.Background
MainFrame.BackgroundTransparency = 0.1 -- Sedikit transparan (Glass effect)
MainFrame.Active = true
MainFrame.ClipsDescendants = false -- Agar shadow bisa keluar frame
createRound(MainFrame, 12)
createStroke(MainFrame, Theme.Colors.Border, 1.5, 0.3)
makeDraggable(MainFrame)

-- SHADOW (GLOW)
local Shadow = Instance.new("ImageLabel", MainFrame)
Shadow.Name = "ShadowGlow"
Shadow.AnchorPoint = Vector2.new(0.5, 0.5)
Shadow.Position = UDim2.new(0.5, 0, 0.5, 0)
Shadow.Size = UDim2.new(1, 40, 1, 40)
Shadow.BackgroundTransparency = 1
Shadow.ZIndex = -1
Shadow.Image = "rbxassetid://6014261993" -- Generic shadow asset
Shadow.ImageColor3 = Color3.new(0, 0, 0)
Shadow.ImageTransparency = 0.4

-- HEADER
local HeaderTitle = Instance.new("TextLabel", MainFrame)
HeaderTitle.Size = UDim2.new(1, -40, 0, 45)
HeaderTitle.Position = UDim2.new(0, 20, 0, 5)
HeaderTitle.Text = "CINEMATIC CONTROL"
HeaderTitle.Font = Theme.Fonts.Title
HeaderTitle.TextColor3 = Theme.Colors.Text
HeaderTitle.TextSize = 16
HeaderTitle.TextXAlignment = Enum.TextXAlignment.Left
HeaderTitle.BackgroundTransparency = 1

local HeaderDecor = Instance.new("Frame", MainFrame)
HeaderDecor.Size = UDim2.new(0, 40, 0, 4)
HeaderDecor.Position = UDim2.new(0, 20, 0, 45)
HeaderDecor.BackgroundColor3 = Theme.Colors.Accent
HeaderDecor.BorderSizePixel = 0
createRound(HeaderDecor, 2)

-- INPUT BUILDER
local function createInputGroup(yPos, placeholder)
    -- Container
    local InputBox = Instance.new("TextBox", MainFrame)
    InputBox.Size = UDim2.new(0.86, 0, 0, 36)
    InputBox.Position = UDim2.new(0.07, 0, yPos, 0)
    InputBox.PlaceholderText = placeholder
    InputBox.Text = ""
    InputBox.Font = Theme.Fonts.Body
    InputBox.TextColor3 = Theme.Colors.Text
    InputBox.PlaceholderColor3 = Theme.Colors.SubText
    InputBox.BackgroundColor3 = Theme.Colors.Input
    InputBox.TextSize = 13
    InputBox.TextXAlignment = Enum.TextXAlignment.Left
    
    local pad = Instance.new("UIPadding", InputBox); pad.PaddingLeft = UDim.new(0, 12)
    createRound(InputBox, 8)
    local stroke = createStroke(InputBox, Theme.Colors.Border, 1, 0.6)
    
    -- Focus Effect
    InputBox.Focused:Connect(function()
        TweenService:Create(stroke, TweenInfo.new(0.3), {Color = Theme.Colors.Accent, Transparency = 0}):Play()
    end)
    InputBox.FocusLost:Connect(function()
        TweenService:Create(stroke, TweenInfo.new(0.3), {Color = Theme.Colors.Border, Transparency = 0.6}):Play()
    end)
    
    -- Dropdown List
    local ListFrame = Instance.new("ScrollingFrame", MainFrame)
    ListFrame.Size = UDim2.new(0.86, 0, 0, 120)
    ListFrame.Position = UDim2.new(0.07, 0, yPos + 0.085, 0)
    ListFrame.BackgroundColor3 = Theme.Colors.Surface
    ListFrame.Visible = false
    ListFrame.ZIndex = 10 -- Pop up diatas element lain
    ListFrame.ScrollBarThickness = 3
    ListFrame.ScrollBarImageColor3 = Theme.Colors.Accent
    ListFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    createRound(ListFrame, 8)
    createStroke(ListFrame, Theme.Colors.Border, 1, 0.5)
    
    local Layout = Instance.new("UIListLayout", ListFrame)
    Layout.SortOrder = Enum.SortOrder.LayoutOrder
    Layout.Padding = UDim.new(0, 2)
    
    local listPad = Instance.new("UIPadding", ListFrame)
    listPad.PaddingTop = UDim.new(0, 5)
    listPad.PaddingLeft = UDim.new(0, 5)
    
    return InputBox, ListFrame, Layout
end

local NameInput1, List1, Layout1 = createInputGroup(0.14, "Primary Target (Player)...")
local NameInput2, List2, Layout2 = createInputGroup(0.23, "Secondary Target (Sym)...")

-- BUTTON BUILDER
local function createButton(yPos, text)
    local Btn = Instance.new("TextButton", MainFrame)
    Btn.Size = UDim2.new(0.86, 0, 0, 38)
    Btn.Position = UDim2.new(0.07, 0, yPos, 0)
    Btn.Text = text
    Btn.Font = Theme.Fonts.Body
    Btn.TextColor3 = Theme.Colors.Text
    Btn.BackgroundColor3 = Theme.Colors.Button
    Btn.AutoButtonColor = false -- Matikan default roblox click effect
    
    createRound(Btn, 8)
    createStroke(Btn, Theme.Colors.Border, 1, 0.7)
    applyHoverEffect(Btn) -- Custom hover effect
    
    return Btn
end

local ToggleBtn = createButton(0.35, "ENABLE FREECAM")
local FollowBtn = createButton(0.45, "ONE-SHOT FOLLOW")
local ControllFollowBtn = createButton(0.55, "FOCUS MODE: OFF")
local SymmetricalBtn = createButton(0.65, "SYMMETRICAL LOCK")

-- INFO PANEL
local InfoFrame = Instance.new("Frame", MainFrame)
InfoFrame.Size = UDim2.new(0.86, 0, 0, 70)
InfoFrame.Position = UDim2.new(0.07, 0, 0.78, 0)
InfoFrame.BackgroundColor3 = Theme.Colors.Input
InfoFrame.BackgroundTransparency = 0.5
createRound(InfoFrame, 8)

local SpeedLabel = Instance.new("TextLabel", InfoFrame)
SpeedLabel.Size = UDim2.new(1, -20, 0, 25)
SpeedLabel.Position = UDim2.new(0, 10, 0, 5)
SpeedLabel.Text = "SPEED: 1.0  //  FOV: 70"
SpeedLabel.Font = Theme.Fonts.Title
SpeedLabel.TextColor3 = Theme.Colors.Accent
SpeedLabel.TextSize = 12
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.BackgroundTransparency = 1

local HintLabel = Instance.new("TextLabel", InfoFrame)
HintLabel.Size = UDim2.new(1, -20, 0, 35)
HintLabel.Position = UDim2.new(0, 10, 0, 30)
HintLabel.Text = "[N] Toggle GUI  |  [Scroll] Zoom\n[Arrows] Speed  |  [Shift] Smooth Mode"
HintLabel.Font = Theme.Fonts.Small
HintLabel.TextColor3 = Theme.Colors.SubText
HintLabel.TextSize = 10
HintLabel.TextXAlignment = Enum.TextXAlignment.Left
HintLabel.BackgroundTransparency = 1

-- === [5. AUTOCOMPLETE LOGIC (ORIGINAL)] ===
local function updatePlayerList(inputBox, listFrame, listLayout)
    -- Clean up
    for _, v in pairs(listFrame:GetChildren()) do
        if v:IsA("TextButton") then v:Destroy() end
    end
    
    local text = inputBox.Text:lower()
    if text == "" then 
        listFrame.Visible = false 
        return 
    end
    
    local matches = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= localPlayer then
            if p.Name:lower():match(text) or p.DisplayName:lower():match(text) then
                table.insert(matches, p)
            end
        end
    end
    
    if #matches > 0 then
        listFrame.Visible = true
        local contentHeight = 10 -- Padding
        
        for _, p in ipairs(matches) do
            local item = Instance.new("TextButton", listFrame)
            item.Size = UDim2.new(1, -10, 0, 28)
            item.BackgroundTransparency = 1
            item.Text = "  " .. p.DisplayName .. " (@" .. p.Name .. ")"
            item.TextColor3 = Theme.Colors.SubText
            item.Font = Theme.Fonts.Small
            item.TextSize = 12
            item.TextXAlignment = Enum.TextXAlignment.Left
            item.ZIndex = 12
            createRound(item, 4)
            
            -- Hover item list
            item.MouseEnter:Connect(function() item.BackgroundTransparency = 0.8; item.BackgroundColor3 = Theme.Colors.Accent end)
            item.MouseLeave:Connect(function() item.BackgroundTransparency = 1 end)
            
            contentHeight = contentHeight + 30
            
            item.MouseButton1Click:Connect(function()
                inputBox.Text = p.Name
                listFrame.Visible = false
                inputBox:ReleaseFocus()
            end)
        end
        listFrame.CanvasSize = UDim2.new(0, 0, 0, contentHeight)
    else
        listFrame.Visible = false
    end
end

NameInput1:GetPropertyChangedSignal("Text"):Connect(function() updatePlayerList(NameInput1, List1, Layout1) end)
NameInput2:GetPropertyChangedSignal("Text"):Connect(function() updatePlayerList(NameInput2, List2, Layout2) end)

NameInput1.FocusLost:Connect(function() task.wait(0.2) List1.Visible = false end)
NameInput2.FocusLost:Connect(function() task.wait(0.2) List2.Visible = false end)

-- === [6. CORE LOGIC (ORIGINAL)] ===
local function getTarget(name)
    if not name or name == "" then return nil end
    for _, p in ipairs(Players:GetPlayers()) do
        if string.find(string.lower(p.DisplayName), string.lower(name)) or string.find(string.lower(p.Name), string.lower(name)) then return p end
    end
    return nil
end

local function setOtherUIVisible(visible)
    pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, visible) end)
    if not visible then
        for _, gui in ipairs(localPlayer.PlayerGui:GetChildren()) do
            if gui:IsA("ScreenGui") and gui ~= ScreenGui and gui.Enabled then
                table.insert(hiddenGuis, gui)
                gui.Enabled = false
            end
        end
    else
        for _, gui in ipairs(hiddenGuis) do
            if gui and gui.Parent then gui.Enabled = true end
        end
        hiddenGuis = {}
    end
end

-- HELPER FOR BUTTON STATE ANIMATION
local function updateBtnState(btn, isActive, activeText, inactiveText)
    btn:SetAttribute("IsActive", isActive) -- Mark attribute for hover logic
    btn.Text = isActive and activeText or inactiveText
    
    local targetColor = isActive and Theme.Colors.ToggleOn or Theme.Colors.Button
    local targetText = isActive and Color3.new(1,1,1) or Theme.Colors.Text
    
    TweenService:Create(btn, TweenInfo.new(0.3), {BackgroundColor3 = targetColor, TextColor3 = targetText}):Play()
end

-- === [7. CAMERA LOOP (ORIGINAL)] ===
RunService.RenderStepped:Connect(function(dt)
    camera.FieldOfView = camera.FieldOfView + (targetFOV - camera.FieldOfView) * normalSmooth
    
    if not freecamEnabled then return end
    
    local isShiftDown = UserInputService:IsKeyDown(Enum.KeyCode.LeftShift)
    local moveSmooth = isShiftDown and shiftSmooth or normalSmooth
    local rotSmooth = isShiftDown and (sensitivity * 0.4) or sensitivity
    
    local moveVector = Vector3.new(0, 0, 0)
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector = moveVector + targetCFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector = moveVector - targetCFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector = moveVector - targetCFrame.RightVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector = moveVector + targetCFrame.RightVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.E) then moveVector = moveVector + Vector3.new(0, 1, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.Q) then moveVector = moveVector - Vector3.new(0, 1, 0) end
    
    local nextPos = targetCFrame.Position + (moveVector * (cameraSpeed * 50) * dt)
    
    if symLockEnabled and targetPlayer1 and targetPlayer2 and targetPlayer1.Character and targetPlayer2.Character then
        local p1 = targetPlayer1.Character:FindFirstChild("HumanoidRootPart")
        local p2 = targetPlayer2.Character:FindFirstChild("HumanoidRootPart")
        if p1 and p2 then
            local midPoint = (p1.Position + p2.Position) / 2
            targetCFrame = CFrame.lookAt(nextPos, midPoint)
        end
    elseif followEnabled and targetPlayer1 and targetPlayer1.Character then
        local char = targetPlayer1.Character
        local lookPart = (followMode == "HEAD" and char:FindFirstChild("Head")) or (followMode == "BODY" and char:FindFirstChild("HumanoidRootPart"))
        if lookPart then
            targetCFrame = CFrame.lookAt(nextPos, lookPart.Position)
        else
            targetCFrame = CFrame.new(nextPos) * CFrame.fromOrientation(math.rad(pan.Y), math.rad(pan.X), 0)
        end
    else
        if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCurrentPosition
            local delta = UserInputService:GetMouseDelta()
            pan = pan - (delta * rotSmooth * 0.1)
        else
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        end
        targetCFrame = CFrame.new(nextPos) * CFrame.fromOrientation(math.rad(pan.Y), math.rad(pan.X), 0)
    end
    
    camera.CFrame = camera.CFrame:Lerp(targetCFrame, moveSmooth)
    SpeedLabel.Text = string.format("SPEED: %.1f  //  FOV: %d %s", cameraSpeed, math.floor(camera.FieldOfView), (isShiftDown and "[SMOOTH]" or ""))
end)

-- === [8. BUTTON CONNECTS (ORIGINAL + ANIMATION)] ===
ToggleBtn.MouseButton1Click:Connect(function()
    freecamEnabled = not freecamEnabled
    updateBtnState(ToggleBtn, freecamEnabled, "FREECAM: ACTIVE", "ENABLE FREECAM")
    
    local char = localPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    
    if freecamEnabled then
        targetCFrame = camera.CFrame
        targetFOV = camera.FieldOfView
        camera.CameraType = Enum.CameraType.Scriptable
        pan = Vector2.new(camera.CFrame:ToOrientation())
        Controls:Disable()
        if hrp then hrp.Anchored = true end
        setOtherUIVisible(false)
    else
        targetFOV = defaultFOV 
        camera.CameraType = Enum.CameraType.Custom
        Controls:Enable()
        if hrp then hrp.Anchored = false end
        setOtherUIVisible(true)
        followEnabled = false
        symLockEnabled = false
        
        -- Reset other buttons visual
        updateBtnState(FollowBtn, false, "", "ONE-SHOT FOLLOW")
        updateBtnState(SymmetricalBtn, false, "", "SYMMETRICAL LOCK")
    end
end)

FollowBtn.MouseButton1Click:Connect(function()
    if not freecamEnabled then return end
    targetPlayer1 = getTarget(NameInput1.Text)
    if targetPlayer1 then
        followEnabled = not followEnabled
        symLockEnabled = false
        
        updateBtnState(FollowBtn, followEnabled, "FOLLOWING TARGET...", "ONE-SHOT FOLLOW")
        updateBtnState(SymmetricalBtn, false, "", "SYMMETRICAL LOCK")
    end
end)

ControllFollowBtn.MouseButton1Click:Connect(function()
    if not freecamEnabled then return end
    if followMode == "OFF" then followMode = "HEAD" elseif followMode == "HEAD" then followMode = "BODY" else followMode = "OFF" end
    
    local isActive = (followMode ~= "OFF")
    updateBtnState(ControllFollowBtn, isActive, "FOCUS: " .. followMode, "FOCUS MODE: OFF")
end)

SymmetricalBtn.MouseButton1Click:Connect(function()
    if not freecamEnabled then return end
    targetPlayer1 = getTarget(NameInput1.Text)
    targetPlayer2 = getTarget(NameInput2.Text)
    if targetPlayer1 and targetPlayer2 then
        symLockEnabled = not symLockEnabled
        followEnabled = false
        
        updateBtnState(SymmetricalBtn, symLockEnabled, "SYMMETRICAL: ACTIVE", "SYMMETRICAL LOCK")
        updateBtnState(FollowBtn, false, "", "ONE-SHOT FOLLOW")
    end
end)

-- === [9. INPUTS (ORIGINAL)] ===
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == Enum.KeyCode.N and not gameProcessed then 
        ScreenGui.Enabled = not ScreenGui.Enabled 
    end
    
    if gameProcessed then return end 
    
    if input.KeyCode == Enum.KeyCode.Up then cameraSpeed = math.clamp(cameraSpeed + 0.1, 0.1, 20)
    elseif input.KeyCode == Enum.KeyCode.Down then cameraSpeed = math.clamp(cameraSpeed - 0.1, 0.1, 20) end
end)

UserInputService.InputChanged:Connect(function(input)
    if not freecamEnabled then return end
    if input.UserInputType == Enum.UserInputType.MouseWheel then
        targetFOV = math.clamp(targetFOV - (input.Position.Z * 5), 5, 120)
    end
end)
